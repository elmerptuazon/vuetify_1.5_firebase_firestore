<template>
	<v-container>
		<v-card>
			<v-card-title>
				<div class="headline">Support</div>
				<v-spacer></v-spacer>
			</v-card-title>
			<v-divider></v-divider>
			<div class="text-xs-center mt-3">
				<v-progress-circular :size="150" :width="5" color="primary" indeterminate v-if="loading"></v-progress-circular>
			</div>
			<v-list two-line>
				<template v-for="(item, index) in items">
					<v-divider v-if="item.divider" :inset="item.inset" :key="index"></v-divider>

					<v-list-tile v-else :key="item.title" avatar @click="viewMessage(item)" ripple :class="[!item.opened ? 'grey lighten-1' : '']">
						<v-list-tile-avatar>
							<img :src="item.user.downloadURL" v-if="item.user.hasPicture" />
							<img :src="userPlaceholder" alt="userPlaceholder" v-else />
						</v-list-tile-avatar>

						<v-list-tile-content>
							<v-list-tile-title>
								{{ item.user.firstName }} {{ item.user.middleInitial || '' }} {{ item.user.lastName }}
							</v-list-tile-title>
							<v-list-tile-sub-title>
								<span class="text--primary">{{ item.createdAt | momentize('MMMM D, YYYY h:mm a') }}</span> &mdash; {{ item.message }}
							</v-list-tile-sub-title>
						</v-list-tile-content>
					</v-list-tile>
				</template>
			</v-list>
		</v-card>

		<v-dialog v-model="dialog" persistent max-width="700">
			<v-card>
				<v-card-title primary-title>
					<div class="headline">
						{{ selectedMessage.name }}
					</div>
					<v-spacer></v-spacer>
					<v-btn icon flat @click="dialog = false">
						<v-icon>close</v-icon>
					</v-btn>
				</v-card-title>
				<v-divider></v-divider>
				<v-card-text>
					<div>
						<strong>Date:</strong> {{ selectedMessage.created | momentize('MMMM D, YYYY, h:mm A') }}
					</div>
					<div v-if="selectedMessage.email">
						<strong>Email Address:</strong> {{ selectedMessage.email }}
					</div>
					<div v-if="selectedMessage.contact">
						<strong>Contact:</strong> {{ selectedMessage.contact }}
					</div>
					<div class="mt-3"></div>
					<p class="text-xs-justify">{{ selectedMessage.message }}</p>
				</v-card-text>
			</v-card>
		</v-dialog>
	</v-container>
</template>

<script>
import mixins from '@/mixins';
import { DB } from '@/config/firebase';
import userPlaceholder from '@/assets/placeholder.png';

const supportCollection = DB.collection('support');
const usersCollection = DB.collection('accounts');

export default {
	data () {
		return {
			items: [],
			userPlaceholder: null,
			loading: false,
			dialog: false,
			selectedMessage: {
				name: null,
				email: null,
				contact: null,
				created: null,
				avatar: null,
				message: null
			}
		}
	},
	async created () {
		try {
			this.loading = true;

			const querySnapshot = await supportCollection.orderBy('createdAt', 'desc').get();

			const messages = querySnapshot.docs.map((doc) => {
				const data = doc.data();
				data.id = doc.id;
				return data;
			});

			this.loading = false;

			const promises = [];

			messages.forEach((message) => {
				promises.push(
					this.findUser(message.uid)
					.then((user) => {
						message.user = user;
						return message;
					})
				);
			});

			this.items = await Promise.all(promises);

		} catch (error) {
			this.loading = false;
			console.log(error);
		}
	},
	methods: {
		async findUser (uid) {
			try {
				const doc = await usersCollection.doc(uid).get();
				return doc.data();
			} catch (error) {
				throw error;
				console.log(error);
			}
		},
		async viewMessage (item) {
			try {

				const {
					firstName,
					middleInitial,
					lastName,
					email,
					contact,
					created,
					downloadURL,
					isEmailAutogenerated
				} = item.user;

				if (!item.opened) {
					await supportCollection.doc(item.id).update({ opened: true });

					const index = this.items.findIndex(i => i.id === item.id);

					if (index !== -1) {
						this.items[index].opened = true;
					}
				}

				this.selectedMessage = {
					name: `${firstName} ${middleInitial || ''} ${lastName}`,
					email: isEmailAutogenerated ? null : email,
					contact: contact,
					created: created,
					avatar: downloadURL ? downloadURL : userPlaceholder,
					message: item.message
				};

				this.dialog = true;

			} catch (error) {
				console.log(error);
			}
		}
	},
	mounted () {
		this.userPlaceholder = userPlaceholder;
	},
	mixins: [mixins]
}
</script>
